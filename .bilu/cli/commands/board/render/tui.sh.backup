#!/usr/bin/env bash
set -euo pipefail

TUI_STTY_SAVED=""
TUI_CLEANED=0

# TUI state
TUI_SEL_COL=0
TUI_SEL_ROW=0
TUI_SEL_ID=""
TUI_NEEDS_REDRAW=1
TUI_VISIBLE_ROWS=5
TUI_COL_WIDTH=20

# Column data (will be populated from TSV)
declare -a TUI_COLUMNS=("Backlog" "In Progress" "Review" "Done")
declare -a TUI_COLUMN_STATS=("BACKLOG TODO" "INPROGRESS BLOCKED" "REVIEW" "DONE")
declare -A TUI_CARDS  # [col_index]="card1,card2,..."  (comma-separated IDs)
declare -A TUI_CARD_COUNTS  # [col_index]=count
declare -A TUI_SCROLL_OFFSETS  # [col_index]=scroll_row

# Load task data into TUI structures
tui_load_tasks() {
  local records_sh tsv_data id status priority_weight priority kind title path tags deps link
  
  # Clear existing data
  TUI_CARDS=()
  TUI_CARD_COUNTS=()
  TUI_SCROLL_OFFSETS=()
  
  # Initialize empty columns
  for ((i=0; i<4; i++)); do
    TUI_CARDS[$i]=""
    TUI_CARD_COUNTS[$i]=0
    TUI_SCROLL_OFFSETS[$i]=0
  done
  
  # Find records_tsv.sh using BOARD_LIB_DIR environment variable if available
  local board_lib_dir="${BOARD_LIB_DIR:-}"
  if [[ -z "$board_lib_dir" ]]; then
    # Fallback: calculate from script location
    board_lib_dir="$(cd "$(dirname -- "$(dirname -- "$0")")" && pwd)"
  fi
  records_sh="$board_lib_dir/records_tsv.sh"
  
  # Load and process TSV data
  if [[ -f "$records_sh" ]] && [[ -n "${BOARD_ROOT:-}" ]]; then
    tsv_data=$(bash "$records_sh" "$BOARD_ROOT" 2>/dev/null || true)
    while IFS=$'\t' read -r id status priority_weight priority kind title path tags deps link; do
      # Determine column based on status
      local col_idx=-1
      case "$status" in
        BACKLOG|TODO) col_idx=0 ;;
        INPROGRESS|BLOCKED) col_idx=1 ;;
        REVIEW) col_idx=2 ;;
        DONE) col_idx=3 ;;
      esac
      
      if [[ $col_idx -ge 0 ]]; then
        local current_cards="${TUI_CARDS[$col_idx]:-}"
        if [[ -n "$current_cards" ]]; then
          TUI_CARDS[$col_idx]="$current_cards,$id"
        else
          TUI_CARDS[$col_idx]="$id"
        fi
        ((TUI_CARD_COUNTS[$col_idx]++))
      fi
    done <<< "$tsv_data"
  fi
  
  # Set initial selection if not set
  if [[ -z "$TUI_SEL_ID" ]]; then
    tui_select_first_available
  fi
}
        BACKLOG|TODO) col_idx=0 ;;
        INPROGRESS|BLOCKED) col_idx=1 ;;
        REVIEW) col_idx=2 ;;
        DONE) col_idx=3 ;;
      esac
      
      if [[ $col_idx -ge 0 ]]; then
        local current_cards="${TUI_CARDS[$col_idx]:-}"
        if [[ -n "$current_cards" ]]; then
          TUI_CARDS[$col_idx]="$current_cards,$id"
        else
          TUI_CARDS[$col_idx]="$id"
        fi
        ((TUI_CARD_COUNTS[$col_idx]++))
      fi
    done < <(echo "$tsv_data")
  fi
  
  # Set initial selection if not set
  if [[ -z "$TUI_SEL_ID" ]]; then
    tui_select_first_available
  fi
}

# Select first available task
tui_select_first_available() {
  for ((col=0; col<4; col++)); do
    local count="${TUI_CARD_COUNTS[$col]:-0}"
    if [[ $count -gt 0 ]]; then
      TUI_SEL_COL=$col
      TUI_SEL_ROW=0
      local cards="${TUI_CARDS[$col]}"
      TUI_SEL_ID="${cards%%,*}"  # First card ID
      return 0
    fi
  done
  TUI_SEL_ID=""
  return 1
}

# Get card ID at specific position
tui_get_card_id() {
  local col=$1 row=$2
  local cards="${TUI_CARDS[$col]:-}"
  local count=0
  
  if [[ -z "$cards" ]]; then
    return 1
  fi
  
  IFS=',' read -ra CARD_ARRAY <<< "$cards"
  if [[ $row -ge ${#CARD_ARRAY[@]} ]]; then
    return 1
  fi
  
  printf '%s' "${CARD_ARRAY[$row]}"
}

# Update selection based on movement
tui_handle_movement() {
  local direction=$1
  local old_col=$TUI_SEL_COL
  local old_row=$TUI_SEL_ROW
  
  case "$direction" in
    UP)
      if [[ $TUI_SEL_ROW -gt 0 ]]; then
        ((TUI_SEL_ROW--))
      fi
      ;;
    DOWN)
      local max_row=$((TUI_CARD_COUNTS[TUI_SEL_COL] - 1))
      if [[ $TUI_SEL_ROW -lt $max_row ]]; then
        ((TUI_SEL_ROW++))
      fi
      ;;
    LEFT)
      if [[ $TUI_SEL_COL -gt 0 ]]; then
        ((TUI_SEL_COL--))
        local target_max=$((TUI_CARD_COUNTS[TUI_SEL_COL] - 1))
        TUI_SEL_ROW=$((TUI_SEL_ROW > target_max ? target_max : TUI_SEL_ROW))
        if [[ $TUI_SEL_ROW -lt 0 ]]; then TUI_SEL_ROW=0; fi
      fi
      ;;
    RIGHT)
      if [[ $TUI_SEL_COL -lt 3 ]]; then
        ((TUI_SEL_COL++))
        local target_max=$((TUI_CARD_COUNTS[TUI_SEL_COL] - 1))
        TUI_SEL_ROW=$((TUI_SEL_ROW > target_max ? target_max : TUI_SEL_ROW))
        if [[ $TUI_SEL_ROW -lt 0 ]]; then TUI_SEL_ROW=0; fi
      fi
      ;;
  esac
  
  # Update selected ID
  TUI_SEL_ID=$(tui_get_card_id "$TUI_SEL_COL" "$TUI_SEL_ROW" || true)
  
  # Update scroll to keep selection visible
  tui_update_scroll
  
  # Mark for redraw if position changed
  if [[ $old_col -ne $TUI_SEL_COL || $old_row -ne $TUI_SEL_ROW ]]; then
    TUI_NEEDS_REDRAW=1
  fi
}

# Update scroll offsets to keep selection visible
tui_update_scroll() {
  local col=$TUI_SEL_COL
  local row=$TUI_SEL_ROW
  local scroll="${TUI_SCROLL_OFFSETS[$col]:-0}"
  
  # Ensure selection is within visible range
  if [[ $row -lt $scroll ]]; then
    TUI_SCROLL_OFFSETS[$col]=$row
  elif [[ $row -ge $((scroll + TUI_VISIBLE_ROWS)) ]]; then
    TUI_SCROLL_OFFSETS[$col]=$((row - TUI_VISIBLE_ROWS + 1))
  fi
}

# Calculate layout based on terminal size
tui_calculate_layout() {
  local rows=${LINES:-24}
  local cols=${COLUMNS:-80}
  
  # Reserve space for header (2 lines) and footer (1 line)
  TUI_VISIBLE_ROWS=$((rows - 3))
  if [[ $TUI_VISIBLE_ROWS -lt 3 ]]; then
    TUI_VISIBLE_ROWS=3
  fi
  
  # Calculate column width (minus borders and spacing)
  TUI_COL_WIDTH=$(((cols - 9) / 4))  # 4 borders + 3 spaces = 7, plus padding
  if [[ $TUI_COL_WIDTH -lt 10 ]]; then
    TUI_COL_WIDTH=10
  fi
}

# Handle window resize
tui_on_resize() {
  tui_calculate_layout
  TUI_NEEDS_REDRAW=1
}

tui_read_key() {
  local key k1 k2 k3

  key=""
  IFS= read -rsn1 -t 0.05 key || true
  if [[ -z "$key" ]]; then
    printf '%s\n' "NONE"
    return 0
  fi

  case "$key" in
    $'\r'|$'\n') printf '%s\n' "ENTER"; return 0 ;;
    $'\x7f'|$'\b') printf '%s\n' "BACKSPACE"; return 0 ;;
  esac

  if [[ "$key" != $'\e' ]]; then
    printf '%s\n' "$key"
    return 0
  fi

  k1=""
  k2=""
  k3=""
  IFS= read -rsn1 -t 0.001 k1 || true
  IFS= read -rsn1 -t 0.001 k2 || true

  case "${k1}${k2}" in
    "[A") printf '%s\n' "UP"; return 0 ;;
    "[B") printf '%s\n' "DOWN"; return 0 ;;
    "[C") printf '%s\n' "RIGHT"; return 0 ;;
    "[D") printf '%s\n' "LEFT"; return 0 ;;
    "OA") printf '%s\n' "UP"; return 0 ;;
    "OB") printf '%s\n' "DOWN"; return 0 ;;
    "OC") printf '%s\n' "RIGHT"; return 0 ;;
    "OD") printf '%s\n' "LEFT"; return 0 ;;
    "[H") printf '%s\n' "HOME"; return 0 ;;
    "[F") printf '%s\n' "END"; return 0 ;;
  esac

  if [[ "$k1" = "[" ]]; then
    case "$k2" in
      1|4|5|6)
        IFS= read -rsn1 -t 0.001 k3 || true
        if [[ "$k3" = "~" ]]; then
          case "$k2" in
            1) printf '%s\n' "HOME"; return 0 ;;
            4) printf '%s\n' "END"; return 0 ;;
            5) printf '%s\n' "PAGEUP"; return 0 ;;
            6) printf '%s\n' "PAGEDOWN"; return 0 ;;
          esac
        fi
        ;;
    esac
  fi

  printf '%s\n' "ESC"
}

board_tui_setup_terminal() {
  TUI_STTY_SAVED="$(stty -g 2>/dev/null || true)"

  printf '\e[?1049h'
  printf '\e[?7l'
  printf '\e[?25l'

  if ! stty -echo -icanon time 0 min 0 2>/dev/null; then
    stty -echo 2>/dev/null || true
  fi

  printf '\e[2J\e[H'
}

board_tui_cleanup_terminal() {
  if [[ "$TUI_CLEANED" -eq 1 ]]; then
    return 0
  fi
  TUI_CLEANED=1

  if [[ -n "$TUI_STTY_SAVED" ]]; then
    stty "$TUI_STTY_SAVED" 2>/dev/null || true
  else
    stty echo icanon 2>/dev/null || true
  fi

  printf '\e[?7h'
  printf '\e[?25h'
  printf '\e[?1049l'
}

# Build frame buffer for rendering
tui_build_frame() {
  local frame=""
  local total_tasks visible_tasks
  local line
  
  # Calculate totals
  total_tasks=0
  for ((i=0; i<4; i++)); do
    total_tasks=$((total_tasks + TUI_CARD_COUNTS[i]))
  done
  visible_tasks=$total_tasks  # For now, no filtering
  
  # Header
  frame+=$'\e[H\e[2J'  # Clear screen and home cursor
  frame+="\e[1;37;44m"  # Bold white on blue for header
  frame+=$(printf " bilu board --tui %*s " $((COLUMNS - 20)) "")
  frame+="\e[0m\n"
  frame+="\e[1;37;44m"
  frame+=$(printf " Tasks: %d visible / %d total%*s " "$visible_tasks" "$total_tasks" $((COLUMNS - 35)) "")
  frame+="\e[0m\n"
  frame+="\n"
  
  # Column headers
  local col_start=1
  for ((i=0; i<4; i++)); do
    local title="${TUI_COLUMNS[i]}"
    local count="${TUI_CARD_COUNTS[i]}"
    local header_text="$title ($count)"
    
    # Position cursor and draw column
    frame+=$(printf "\e[3;%dH" $col_start)
    if [[ $i -eq $TUI_SEL_COL ]]; then
      frame+="\e[1;33;44m"  # Yellow on blue for selected column
    else
      frame+="\e[1;37;44m"  # White on blue
    fi
    frame+=$(printf "%-*s" $((TUI_COL_WIDTH)) "$header_text")
    frame+="\e[0m"
    
    col_start=$((col_start + TUI_COL_WIDTH + 2))
  done
  
  # Draw cards in each column
  local line_num=4  # Start after headers
  for ((row=0; row<TUI_VISIBLE_ROWS; row++)); do
    local col_start=1
    
    for ((col=0; col<4; col++)); do
      local card_id=""
      local scroll="${TUI_SCROLL_OFFSETS[$col]:-0}"
      local actual_row=$((scroll + row))
      
      card_id=$(tui_get_card_id "$col" "$actual_row" || true)
      
      frame+=$(printf "\e[%d;%dH" $line_num $col_start)
      
      if [[ -n "$card_id" ]]; then
        # This is a card - draw it
        local is_selected=0
        if [[ $col -eq $TUI_SEL_COL && $actual_row -eq $TUI_SEL_ROW ]]; then
          is_selected=1
        fi
        
        if [[ $is_selected -eq 1 ]]; then
          frame+="\e[1;33;47m"  # Yellow on white for selected card
        else
          frame+="\e[0;37;47m"  # White on white for regular cards
        fi
        
        # Truncate card ID to fit column width
        local display_id="${card_id:0:$((TUI_COL_WIDTH - 1))}"
        frame+=$(printf "%-*s" $((TUI_COL_WIDTH)) "$display_id")
        frame+="\e[0m"
      else
        # Empty space
        frame+=$(printf "%-*s" $((TUI_COL_WIDTH)) " ")
      fi
      
      col_start=$((col_start + TUI_COL_WIDTH + 2))
    done
    
    line_num=$((line_num + 1))
  done
  
  # Footer/status bar
  local footer_line=$((LINES))
  frame+=$(printf "\e[%d;H" $footer_line)
  frame+="\e[1;37;44m"
  frame+=$(printf " q:quit ↑↓←→:navigate ?:help %*s " $((COLUMNS - 35)) "")
  if [[ -n "$TUI_SEL_ID" ]]; then
    frame+=" Selected: $TUI_SEL_ID"
  fi
  frame+="\e[0m"
  
  printf '%b' "$frame"
}

board_tui_draw() {
  if [[ $TUI_NEEDS_REDRAW -eq 1 ]]; then
    tui_build_frame
    TUI_NEEDS_REDRAW=0
  fi
}

board_tui_handle_key() {
  local key=$1
  
  case "$key" in
    q) return 1 ;;  # Signal to quit
    UP|k) tui_handle_movement "UP" ;;
    DOWN|j) tui_handle_movement "DOWN" ;;
    LEFT|h) tui_handle_movement "LEFT" ;;
    RIGHT|l) tui_handle_movement "RIGHT" ;;
    HOME) tui_handle_movement "HOME" ;;
    END) tui_handle_movement "END" ;;
    PAGEUP) tui_handle_movement "PAGEUP" ;;
    PAGEDOWN) tui_handle_movement "PAGEDOWN" ;;
    ENTER|NONE) ;;  # No action needed
    *) TUI_NEEDS_REDRAW=1 ;;  # Unknown key, mark for redraw
  esac
  
  return 0
}

board_tui_main_loop() {
  local key
  
  # Initial setup
  tui_calculate_layout
  tui_load_tasks
  TUI_NEEDS_REDRAW=1
  
  # Main loop
  while true; do
    # Always draw current state
    board_tui_draw
    
    # Read key (non-blocking)
    key="$(tui_read_key)"
    
    # Handle key - return 1 means quit
    if ! board_tui_handle_key "$key"; then
      return 0
    fi
    
    # Small sleep to prevent CPU spin when idle
    if [[ "$key" == "NONE" && $TUI_NEEDS_REDRAW -eq 0 ]]; then
      sleep 0.01
    fi
  done
}

board_tui_main() {
  if [[ ! -t 0 || ! -t 1 ]]; then
    printf "%s\n" "bilu board --tui requires a TTY" >&2
    return 1
  fi

  # Source required libraries
  local script_dir
  script_dir="$(dirname -- "$0")"
  
  # Source paths detection
  if [[ -f "$script_dir/../paths.sh" ]]; then
    # shellcheck source=../paths.sh
    . "$script_dir/../paths.sh"
  fi
  
  # Source column configuration
  if [[ -f "$script_dir/../ui/columns.sh" ]]; then
    # shellcheck source=../ui/columns.sh
    . "$script_dir/../ui/columns.sh" "__lib__"
    board_columns_init
  fi

  # Set up traps
  trap board_tui_cleanup_terminal EXIT INT TERM
  trap 'tui_on_resize; TUI_NEEDS_REDRAW=1' WINCH
  
  # Initialize terminal and start main loop
  board_tui_setup_terminal
  board_tui_main_loop
}

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
  board_tui_main "$@"
fi
