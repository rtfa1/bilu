# Phase 01 — Parsing strategy (no `jq`)

## Goal

Define how shell scripts parse `config.json`, `default.json`, and `tasks/*.md` safely.

## Constraints

- No `jq` dependency.
- Keep parsing limited to the known schema; fail gracefully with clear errors.

## Checklist

- [x] Decide whether JSON parsing uses:
  - [ ] `python3 -c` helper (optional enhancement; not required)
  - [x] `awk` schema-specific extraction only (for small, known shapes)
- [x] Define markdown parsing approach:
  - [x] parse `# Title`, `# Description`, `# Priority`, `# Status`, `# depends_on`
- [x] Define handling for missing files and broken links (warn vs error).

## Acceptance

- Parsing approach is documented and chosen to be portable and maintainable.
---

## Implementation plan

# Phase 01 Task Implementation Plan — Parsing strategy (no `jq`)

Task: `.bilu/board/tasks/01-04-json-and-markdown-parsing-strategy.md`

This implementation plan chooses a parsing approach that is portable, maintainable, and consistent with `.bilu/storage/research/shell-only-cli-advanced-notes.md`: avoid runtime JSON parsing in shell when possible, prefer “compile”/derive an internal TSV, and use `awk` for structured transforms.

## Outcome (what “done” means)

1) The project makes an explicit decision for:
- how JSON is handled without `jq`
- how task markdown is parsed
2) The decision is documented as “the way” and referenced by loaders.
3) Missing/broken file handling is specified (warn vs error) and consistent with `--validate`.

## Recommended decision (portable and least fragile)

### Primary strategy: markdown is authoritative; runtime reads markdown

Per Phase 01-01 and the research note:
- Treat `.bilu/board/tasks/*.md` as the source of truth.
- Parse markdown at runtime for `--list` and renderers.

### Derived artifacts: compile to TSV and (optionally) JSON explicitly

Avoid parsing JSON at runtime by introducing explicit build steps:
- `bilu board --rebuild-index` generates:
  - an internal TSV cache (preferred) for fast rendering, and optionally
  - `.bilu/board/default.json` for compatibility/inspection

This follows “Strategy A” from the research note: compile structured data during init/rebuild rather than parsing JSON in hot paths.

### JSON usage

Keep runtime JSON usage minimal:
- `.bilu/board/config.json` is small and stable; it can be:
  - compiled to TSV key-value lines during `--rebuild-index`, or
  - read with schema-specific `awk` extraction if you choose not to compile

Recommendation:
- Prefer compilation so runtime render paths read TSV only.

## Alternatives (if you must parse JSON at runtime)

If you need runtime JSON parsing without `jq`, choose one explicitly:

### Option B: schema-specific `awk` extraction

Allowed if:
- you only parse the exact JSON you generate
- you accept schema brittleness

Scope it tightly:
- parse only the keys you need (status order, priority weights, etc.)
- keep JSON formatting deterministic if generated by your own tool

### Option C: optional `python3 -c` helper

Pragmatic compromise:
- If `python3` exists, use it to parse JSON safely.
- If not, fall back to markdown-derived TSV.

This is consistent with the research note and keeps the runtime “shell-only” while avoiding writing a JSON parser.

## Markdown parsing approach (authoritative)

Parse a limited, well-defined subset of the markdown structure (no full markdown parsing).

### Sections to parse

From each `.bilu/board/tasks/*.md`:
- `# Title` → single-line value
- `# Description` → text block until next `#` header
- `# Priority` → single-line value
- `# Status` → single-line value
- `# depends_on` → list block (could be `[]` or `- item` lines)

### Recommended parser implementation

Use `awk`:
- it handles multi-line blocks cleanly
- it is portable across macOS/Linux
- it avoids relying on GNU `sed` extensions

Output should be normalized TSV (per `01-02-normalized-task-schema.md`):
- ensure tab/newline escaping is applied
- normalization rules apply to `status`/`priority`/`kind`

## Missing files and broken references (warn vs error)

Define consistent behavior across commands:

### Default behavior for render commands (`--list`, `--view=...`)

- Missing task file referenced by index/link: **warn** and continue rendering.
- Missing `depends_on` targets: **warn** and continue.

### Validation behavior (`bilu board --validate`)

As per `01-05-validation-command.md`:
- In `--validate`:
  - missing required files/sections can be treated as errors (exit `1`)
  - missing `depends_on` targets and broken links are configurable:
    - default warn-only, or
    - strict mode later

## Portability guardrails (must follow)

Per the research note:
- Avoid GNU-only flags:
  - no `grep -P`, no `sed -r`, no `xargs -d`, etc.
- Prefer `awk` for structured extraction.
- Do not require bash for non-interactive parsing paths.

## Tests to lock parsing behavior

Add tests that verify parsing without relying on ANSI:
- A markdown fixture with known sections produces expected TSV fields.
- Status/priority variants normalize correctly from markdown.
- Missing optional sections behave as documented (default values + warnings).

## Acceptance checks

- The repo documents a single chosen parsing strategy (no ambiguity).
- Non-interactive render paths do not require runtime JSON parsing beyond the chosen strategy.
- Markdown parsing is implemented with a portable approach (`awk`-based) and produces the normalized TSV format.

## References

- `.bilu/board/tasks/01-04-json-and-markdown-parsing-strategy.md`
- `.bilu/storage/research/shell-only-cli-advanced-notes.md`
- `.bilu/board/tasks/00-02-board-data-audit.md`
- `.bilu/board/tasks/01-05-validation-command.md`
- `.bilu/board/tasks/01-02-normalized-task-schema.md`

---

## Outcomes

- Chose the “no runtime JSON parsing in render paths” policy: markdown is authoritative, with small schema-specific `awk` extraction only where needed (no `jq`, no required `python3`).
- Documented the authoritative markdown sections to parse and the warn-vs-error behavior for missing/broken references.
